# n8n 2.4.6 Upgrade - January 28, 2026

## Overview

Successfully upgraded both staging and production n8n instances from version 1.x/2.1.x to **n8n 2.4.6** (latest stable).

## Upgrade Summary

| Environment | Previous Version | New Version | Date | Status |
|-------------|------------------|-------------|------|--------|
| **Staging** | 1.116.2 | 2.4.6 | 2026-01-28 | ✅ Complete |
| **Production** | 2.1.4 | 2.4.6 | 2026-01-28 | ✅ Complete |

## Pre-Upgrade Backups

### Staging Backups
| Backup Type | File | Size |
|-------------|------|------|
| Database | `n8n-db-backup-before-2x-migration-20260128-160757.sql` | ~17MB |
| Compose File | `docker-compose-backup-before-2x-20260128-160758.yml` | ~2KB |

### Production Backups
| Backup Type | File | Size |
|-------------|------|------|
| Database | `n8n-prod-db-backup-before-2x-upgrade-20260128-184731.sql` | ~24MB |
| Compose File | `n8n-prod-compose-backup-before-2x-upgrade-20260128-184736.yml` | ~2KB |

## Database Migrations Applied

n8n 2.4.6 automatically applied these migrations on startup:

1. ✅ **AddWorkflowVersionIdToExecutionData** (1765892199653)
   - Adds workflow version tracking to execution data
   - Enables better execution history management

2. ✅ **AddWorkflowPublishScopeToProjectRoles** (1766064542000)
   - New publishing system for workflows
   - Adds `workflow:publish` scope to project roles with `workflow:update`

3. ✅ **AddChatMessageIndices** (1766068346315)
   - Performance improvements for Chat Hub
   - New indices for chat message queries

4. ✅ **ExpandInsightsWorkflowIdLength** (1766500000000)
   - Insights workflow ID field expansion
   - Supports longer workflow identifiers

## Breaking Changes in n8n 2.x

### Sub-Workflow Data Flow
- **v1 behavior**: Execute Workflow was "fire and forget" - no output returned
- **v2 behavior**: Returns actual sub-workflow result as data
- **Impact**: Workflows using sub-workflows may need updates to handle new output structure

### Start Node Removal
- **Change**: Sub-workflows no longer have Start nodes
- **Impact**: Sub-workflows need restructuring, especially those using triggers

### Publishing Requirement
- **Change**: Workflows must be explicitly "published" to be callable
- **Impact**: Parent workflows need their target sub-workflows published

### Security Fixes
- **Rudderstack SDK**: Upgraded from 2.1.4 → 3.0.0 (security fix)
- **Git Node**: Parameter handling hardening (command injection prevention)
- **MCP Client Tool**: Tool argument sanitization
- **Form Trigger**: Authentication fixes for POST requests

## Workflows Using Sub-Workflows

### Analysis Results (Pre-Upgrade)

**Staging (n8n.accelior.com)**:
- Total workflows: 102
- Active workflows: 30
- Workflows using `executeWorkflow`: 8 (all research/test workflows - not critical)

**Production (n8n.acmea.tech)**:
- Similar structure with research workflows
- No critical production workflows affected by sub-workflow breaking changes

## Upgrade Procedures

### Staging Upgrade (192.168.1.20)

```bash
# 1. Create backups
ssh root@192.168.1.20 'docker exec n8n-postgres pg_dump -U n8n n8n' > staging-backup.sql
ssh root@192.168.1.20 'cat /home/n8n_compose/docker-compose.yml' > compose-backup.yml

# 2. Update image version
ssh root@192.168.1.20 'cd /home/n8n_compose && \
  sed -i "s/image: docker.n8n.io\/n8nio\/n8n:latest/image: docker.n8n.io\/n8nio\/n8n:2.4.6/" docker-compose.yml'

# 3. Pull and restart
ssh root@192.168.1.20 'cd /home/n8n_compose && docker compose pull && docker compose up -d'

# 4. Verify
ssh root@192.168.1.20 'docker logs n8n-n8n-1 --tail 30'
curl -s https://n8n.accelior.com/
```

### Production Upgrade (135.181.154.169)

**Note**: Production server had docker-compose compatibility issues (Docker 28.5.1 vs docker-compose 1.28.6). Containers were started manually using `docker run`.

```bash
# 1. Create backups
ssh root@135.181.154.169 'docker exec n8n-postgres pg_dump -U n8n n8n' > prod-backup.sql
ssh root@135.181.154.169 'cat /opt/n8n/docker-compose.yml' > compose-backup.yml

# 2. Stop old containers
ssh root@135.181.154.169 'docker stop n8n-n8n-1 n8n-postgres n8n-gotenberg-1'
ssh root@135.181.154.169 'docker rm n8n-n8n-1 n8n-postgres n8n-gotenberg-1'

# 3. Start postgres (using docker run due to compose incompatibility)
ssh root@135.181.154.169 'docker run -d \
  --name n8n-postgres \
  --restart always \
  -e POSTGRES_DB=n8n \
  -e POSTGRES_USER=n8n \
  -e POSTGRES_PASSWORD=jLLkxRB2mGxYHqVOeh1fTfy3o3gQfrZ \
  -v n8n_postgres_data:/var/lib/postgresql/data \
  -v /opt/n8n:/backup \
  --network n8n_default \
  postgres:16-alpine'

# 4. Start gotenberg
ssh root@135.181.154.169 'docker run -d \
  --name n8n-gotenberg-1 \
  --restart always \
  --network n8n_default \
  gotenberg/gotenberg:8'

# 5. Start n8n with postgres IP (DNS resolution issue workaround)
ssh root@135.181.154.169 'docker run -d \
  --name n8n-n8n-1 \
  --restart always \
  --user node \
  -p 5678:5678 \
  -e DB_TYPE=postgresdb \
  -e DB_POSTGRESDB_HOST=172.21.0.2 \
  ... (full environment variables) \
  docker.n8n.io/n8nio/n8n:2.4.6'

# 6. Verify
ssh root@135.181.154.169 'docker logs n8n-n8n-1 --tail 30'
curl -s https://n8n.acmea.tech/
```

## Post-Upgrade Verification

### Health Checks
- ✅ Staging: https://n8n.accelior.com/ (HTTP 200)
- ✅ Production: https://n8n.acmea.tech/ (HTTP 200)

### Active Workflows
Both instances activated workflows successfully on startup including:
- Send Email Order Confirmation
- WanderWish Email Notifications
- Back Up Your n8n Workflows To Github
- VideoSnap-Summarizer workflows

## Known Issues

### Production DNS Resolution
**Issue**: Docker DNS not resolving `postgres` hostname on production server
**Workaround**: Using IP address (172.21.0.2) for DB connection
**Root Cause**: Docker/docker-compose version incompatibility
**Impact**: None - production running successfully with IP configuration

### Rollback Procedures

**Staging Rollback**:
```bash
ssh root@192.168.1.20 'cd /home/n8n_compose && \
  sed -i "s/image: docker.n8n.io\/n8nio\/n8n:2.4.6/image: docker.n8n.io\/n8nio\/n8n:latest/" \
  docker-compose.yml && docker compose up -d'
```

**Production Rollback**:
Due to manual container configuration, rollback requires:
1. Stop current containers
2. Update compose file to previous version
3. Restart containers manually with `docker run`

## References

### Official Documentation
- [n8n v2.0 Breaking Changes](https://docs.n8n.io/2-0-breaking-changes/)
- [v2.0 Migration Tool](https://docs.n8n.io/migration-tool-v2/)
- [Introducing n8n 2.0](https://blog.n8n.io/introducing-n8n-2-0/)

### Community Guides
- [WotAI: n8n v2.0 Migration Guide](https://wotai.co/blog/n8n-v2-migration-guide)
- [Zeabur: n8n v2 Migration Guide](https://zeabur.com/blogs/n8n-v2-migration-guide)

### GitHub Issues
- [GitHub Issue #24036 - Undocumented Breaking Changes](https://github.com/n8n-io/n8n/issues/24036)

## Next Steps

### Testing Recommendations
1. Test workflows using sub-workflows (Execute Workflow node)
2. Verify webhook functionality
3. Test AI features and LangChain integrations
4. Monitor logs for migration-related errors

### Future Upgrades
- Monitor for n8n 2.5.x stable releases
- Consider fixing production docker-compose incompatibility
- Evaluate need for external task runners (Python)

---

**Upgrade Date**: January 28, 2026
**Performed By**: Infrastructure Team
**Status**: ✅ Complete
**Next Review**: As needed for future n8n versions
