# Hestia Exim Template Corruption - Recurrence #4 (2026-01-17)

**Date**: 2026-01-17
**Severity**: Critical - Email Delivery Failure
**Affected Service**: HestiaCP Mail Server (mail.vega-messenger.com / 192.168.1.30)
**Status**: ‚úÖ **RESOLVED** (Root Cause Identified - Fix Committed)
**Recurrence Count**: 4th incident (previous: 2026-01-14, 2026-01-15, 2026-01-02)

---

## Executive Summary

**Critical Issue**: Incoming email delivery failed for `jmvl@accelior.com` (and likely other addresses) due to corrupted Exim configuration template. This is the **4th recurrence** of the same issue.

**Impact**:
- All incoming emails to `jmvl@accelior.com` rejected with "rejected RCPT" error
- User reported: "can't receive email to jmvl@accelior.com (AGAIN)"
- Downtime: Unknown duration (discovered at 17:09 UTC, fix applied at 17:19 UTC)

**Resolution**:
- Restored proper Exim template from known working backup
- Regenerated Exim configuration
- Reloaded Exim service
- Test email delivered successfully

---

## Root Cause

### Primary Issue: Corrupted Exim Template (AGAIN)

The `/etc/exim4/exim4.conf.template` file was replaced with a **26-line "Simplified Macros" template** (1367 bytes) instead of the full Hestia configuration (~513 lines, 19KB).

**What Was Broken**:
- Template only contained macro definitions (SMTP_RELAY_FILE, OUTGOING_IP, DKIM_FILE)
- Missing: All Hestia-specific domain routers and transports
- Missing: `domainlist local_domains = dsearch;/etc/exim4/domains/ : lsearch;/etc/exim4/domains/domains.list`
- Result: Exim could not discover Hestia mail domains, making all local mail undeliverable

**Evidence**:
```bash
# Template size check
wc -l /etc/exim4/exim4.conf.template
# Output: 26 (should be ~513)

# Template content
head -10 /etc/exim4/exim4.conf.template
# Exim4 Configuration Template - Simplified Macros
# Deployed by Ansible - Hestia Mail Server Maintenance
# Purpose: Simplified macros to prevent "tainted filename" errors
```

---

## Timeline

| Time | Event |
|------|-------|
| 2026-01-17 02:00:25 | Template replaced with broken version (based on file mtime) |
| 2026-01-17 02:00:26 | Exim config regenerated from broken template |
| 2026-01-17 02:00:47 | Exim reloaded, paniclog alert triggered |
| 2026-01-17 15:33:44 | First rejection logged (merchmix.org) |
| 2026-01-17 16:14:45 | GitHub email rejected |
| 2026-01-17 17:09:06 | Latest rejection logged (privy.io) |
| 2026-01-17 17:19:36 | Template restored from backup |
| 2026-01-17 17:19:37 | Exim config regenerated and reloaded |
| 2026-01-17 17:20:31 | Test email delivered successfully |

---

## Resolution Steps

### Step 1: Backup Current Broken Configuration
```bash
ssh root@192.168.1.30
cp /etc/exim4/exim4.conf.template \
   /etc/exim4/exim4.conf.template.broken-20260117-171936
```

### Step 2: Restore Working Template
```bash
cp /etc/exim4/exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06 \
   /etc/exim4/exim4.conf.template
```

### Step 3: Verify Template Size
```bash
wc -l /etc/exim4/exim4.conf.template
# Output: 513 /etc/exim4/exim4.conf.template ‚úÖ
```

### Step 4: Regenerate Exim Configuration
```bash
update-exim4.conf
```

### Step 5: Verify Generated Config
```bash
wc -l /var/lib/exim4/config.autogenerated
# Output: 465 /var/lib/exim4/config.autogenerated ‚úÖ
```

### Step 6: Reload Exim Service
```bash
systemctl reload exim4
```

### Step 7: Clear Paniclog
```bash
echo > /var/log/exim4/paniclog
```

### Step 8: Verify Email Routing
```bash
exim4 -bt jmvl@accelior.com
# Output: jmvl@accelior.com
#         router = localuser, transport = local_delivery ‚úÖ
```

### Step 9: Test Email Delivery
```bash
echo "Test email from Hestia recovery" | mail -s "Test - Email recovered" jmvl@accelior.com
# Verified in logs: 1vh9yR-00DsLG-QI => jmvl <jmvl@accelior.com> R=localuser T=local_delivery
# 1vh9yR-00DsLG-QI Completed ‚úÖ
```

---

## Pattern Analysis (4 Recurrences)

This issue has recurred **4 times**:

| Date | Incident | Root Cause | Fix |
|------|----------|------------|-----|
| 2026-01-02 | "Tainted filename" errors | Template expansion issues | Template modifications |
| 2026-01-14 | Complete email failure | Template corrupted (15-line config) | Restored from backup |
| 2026-01-15 | Catch-all not working | Template corrupted (26-line config) | Restored from backup |
| 2026-01-17 | Email rejection (jmvl@accelior.com) | Template corrupted (26-line config) | Restored from backup |

### Pattern: Daily 02:00 UTC Replacement

**Critical Finding**: The template is being replaced **every day at 02:00 UTC**.

Evidence from backup timestamps:
```
-rw-r--r-- 1 root root 19603 Jan 16 16:12 exim4.conf.template.backup-2026-01-17T02-00-03Z (working)
-rw-r--r-- 1 root root 19603 Jan 15 11:09 exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06 (working)
-rw-r--r-- 1 root root 1367 Jan 16 16:12 exim4.conf.template.backup-2026-01-11T02-00-03Z (broken)
-rw-r--r-- 1 root root 1367 Jan 10 02:00 exim4.conf.template.backup-2026-01-13T02-00-04Z (broken)
```

The pattern:
1. **02:00:01 UTC** - Cron jobs run (`v-update-sys-queue restart`, `v-update-sys-queue backup`)
2. **02:00:25 UTC** - Template gets replaced with broken version
3. **02:00:26 UTC** - `update-exim4.conf` runs (creating backup with timestamp)
4. **02:00:47 UTC** - Exim reloads, paniclog alert triggers

---

## Investigation: What's Causing the 02:00 Replacement?

### Hypotheses Investigated

#### 1. Hestia Cron Jobs
**Status**: Unlikely
- `v-update-sys-queue restart` runs at 02:00:01
- `v-update-sys-queue backup` runs at 02:00:01
- These scripts don't directly modify Exim templates

#### 2. Ansible Deployment
**Status**: Unlikely
- Ansible task `deploy_exim4_template` is **commented out** in `ansible/roles/hestia/tasks/exim_config.yml` (lines 45-46)
- Local Ansible template file: `ansible/roles/hestia/templates/exim4.conf.template.j2.DANGEROUS_DO_NOT_USE` (renamed)
- No Ansible cron jobs on pve2 that match 02:00 timing

#### 3. apt-daily / unattended-upgrades
**Status**: Ruled out
- `apt-daily.timer` runs at 04:52 UTC, not 02:00
- `apt-daily-upgrade.timer` runs at 06:35 UTC, not 02:00
- No dpkg.log entries at 02:00 on 2026-01-17

#### 4. Hestia Install/Upgrade Scripts
**Status**: Ruled out
- `/usr/local/hestia/install/deb/exim/exim4.conf.template` is the **correct working version** (481 lines)
- Hestia upgrade scripts don't reference Exim template replacement

#### 5. File Synchronization Tools
**Status**: Ruled out
- No lsyncd, csync2, or unison installed
- No inotify processes running

### üî• ROOT CAUSE IDENTIFIED (2026-01-17 18:30 UTC)

**The Ansible Task Was ACTIVE in Git, Commented Out Locally (Uncommitted)**

Through git analysis, the root cause was identified:

1. **Commit 622f319** (2026-01-08 20:54:00) contained the **ACTIVE** dangerous Exim template deployment task
2. After the 2026-01-15 incident, someone manually commented out the task **locally** but **never committed the change**
3. When Ansible runs at 02:00, it uses the **committed version** which has the task ENABLED
4. This causes the broken template to be deployed daily

**Git Evidence**:
```bash
# The dangerous task was ACTIVE in commit 622f319
- name: Deploy Exim4 template with simplified macros (prevents tainted filename errors)
  template:
    src: exim4.conf.template.j2
    dest: /etc/exim4/exim4.conf.template

# But was commented out locally (uncommitted change)
# CRITICAL: This task MUST REMAIN DISABLED to prevent mail delivery failures
# - name: Deploy Exim4 template with simplified macros...
```

**Fix Applied**:
- Committed the local change that comments out the dangerous task (commit 9f0aa26)
- The Ansible role now has the task properly disabled in the git repository
- Future Ansible runs will use the corrected version

### Outstanding Questions

**What triggers the Ansible HestiaCP maintenance playbook at 02:00 daily?**

**‚úÖ RESOLVED**: Found the trigger on PCT-110 (Ansible container on pve2)

**Root Cause Chain**:
1. **PCT-110** (ansible-mgmt container on pve2) has a cron job at 02:00 daily:
   ```cron
   0 2 * * * /usr/bin/ansible-playbook /etc/ansible/playbooks/hestia-mail-maintenance.yml --tags logs
   ```
2. The playbook on PCT-110 includes the `hestia` role which has `exim_config.yml`
3. **PCT-110 had the dangerous task ACTIVE** (not commented out)
4. When the cron ran at 02:00, Ansible deployed the broken 26-line template

**Fix Deployed**:
- ‚úÖ Local git repo: Commit 9f0aa26 (dangerous task commented out)
- ‚úÖ **PCT-110**: Deployed fixed `exim_config.yml` at 18:45 UTC
- ‚úÖ Verified dangerous task is now commented out on PCT-110

**Next steps**:
1. ‚úÖ Monitoring deployed (will verify fix works tomorrow at 02:00)
2. ‚úÖ Fix committed to git (dangerous task now disabled in repository)
3. ‚úÖ Fix deployed to PCT-110 (Ansible container that runs the 02:00 cron)
4. ‚è≥ Verify tomorrow that no template corruption occurs

---

## Temporary Mitigation

### Monitoring Script
Create a script to check template integrity and alert if corrupted:

```bash
#!/bin/bash
# /usr/local/bin/exim-template-monitor.sh

TEMPLATE="/etc/exim4/exim4/conf.template"
MIN_SIZE=10000  # Minimum expected size in bytes

if [ $(stat -c%s "$TEMPLATE") -lt $MIN_SIZE ]; then
    logger -t exim-template-monitor -p mail.alert "CRITICAL: Exim template corrupted ($(stat -c%s "$TEMPLATE") bytes)"
    # Optionally restore from known good backup
    cp /etc/exim4/exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06 "$TEMPLATE"
    update-exim4.conf && systemctl reload exim4
    logger -t exim-template-monitor -p mail.info "Template restored from backup"
fi
```

Add to cron to run every 5 minutes:
```bash
*/5 * * * * /usr/local/bin/exim-template-monitor.sh
```

### Immutable Template (Nuclear Option)
Make the template immutable to prevent modifications:
```bash
chattr +i /etc/exim4/exim4.conf.template
```
(Use with caution - will prevent legitimate updates too)

---

## Reference Configuration

**Working Template** (2026-01-15):
- File: `exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06`
- MD5: `44839e06e93d36e49e98658f1bc900b5`
- Size: 20KB
- Lines: 513
- Key Feature: `domainlist local_domains = dsearch;/etc/exim4/domains/ : lsearch;/etc/exim4/domains/domains.list`

**Broken Template**:
- Size: 1367 bytes
- Lines: 26
- Content: Only macro definitions (SMTP_RELAY_FILE, OUTGOING_IP, DKIM_FILE)
- Missing: All Hestia-specific routers and transports

---

## Related Documentation

- `/docs/troubleshooting/2026-01-15-hestia-exim-catchall-not-working-fix.md`
- `/docs/troubleshooting/2026-01-14-hestia-exim-config-corruption-fix.md`
- `/docs/hestia/hestia-mail-server-maintenance-intervention-2026-01-08.md`
- `ansible/roles/hestia/tasks/exim_config.yml`

---

## Monitoring Deployed (2026-01-17 18:00 UTC)

To catch the culprit tomorrow, inotify monitoring has been deployed:

### What Was Set Up:

1. **Monitoring Script**: `/usr/local/bin/watch-exim-template.sh`
   - Uses `inotifywait` to watch for file modifications
   - Captures process list when modification occurs
   - Copies modified template for analysis
   - Logs all events to `/var/log/exim-template-modifications.log`

2. **Systemd Service**: `exim-template-monitor.service`
   - Runs continuously in background
   - Auto-restarts if fails
   - Currently **active and running**

3. **Systemd Timer**: `exim-template-monitor.timer`
   - Ensures monitoring starts at 01:55 UTC daily (5 minutes before expected event)
   - Next run: 2026-01-18 01:55 UTC

### What Tomorrow Will Capture:

When/if the template is modified at 02:00 UTC, the monitor will log:
- Exact timestamp of modification
- Full process list (to identify what process did it)
- Copy of the modified template
- First 30 lines of the template content

### To Check Results Tomorrow:

```bash
# Quick status check
ssh root@192.168.1.30 check-exim-monitor

# View detailed logs
ssh root@192.168.1.30 tail -100 /var/log/exim-template-modifications.log

# List captured templates
ssh root@192.168.1.30 ls -la /var/log/exim-template-captures/
```

### Log Files:

- `/var/log/exim-template-modifications.log` - Main monitoring log
- `/var/log/exim-template-captures/` - Captured template copies
- `journalctl -u exim-template-monitor` - Service logs

---

## Status

‚úÖ **FULLY RESOLVED** - Root cause identified and fix deployed to all systems.

### Root Cause Summary

The daily 02:00 UTC template corruption was caused by **PCT-110 (Ansible container on pve2)** running a cron job that deployed a broken Exim template:

```cron
# PCT-110 crontab at /etc/cron.d/hestia
0 2 * * * /usr/bin/ansible-playbook /etc/ansible/playbooks/hestia-mail-maintenance.yml --tags logs
```

### The Problem Chain

1. **Commit 622f319** (2026-01-08) contained the dangerous Exim template deployment task **ACTIVE**
2. After the 2026-01-15 incident, the task was commented out **locally** but never:
   - Committed to git
   - Deployed to PCT-110 (the actual Ansible runner)
3. **PCT-110 had the ACTIVE version** and ran daily at 02:00
4. Each run deployed the broken 26-line template, breaking email delivery

### Fixes Applied

| System | Location | Status | Details |
|--------|----------|--------|---------|
| Local git repo | `ansible/roles/hestia/tasks/exim_config.yml` | ‚úÖ Fixed | Commit 9f0aa26 - task commented out |
| PCT-110 | `/etc/ansible/roles/hestia/tasks/exim_config.yml` | ‚úÖ Fixed | Deployed at 18:45 UTC |
| Hestia VM | `/etc/exim4/exim4.conf.template` | ‚úÖ Restored | Working backup (20KB, 513 lines) |
| Hestia VM | `/usr/local/bin/watch-exim-template.sh` | ‚úÖ Active | Monitoring will verify fix works |

### Verification

**Dangerous task is now commented out on PCT-110**:
```yaml
# CRITICAL: This task MUST REMAIN DISABLED to prevent mail delivery failures
# The simplified template (1.3KB) breaks Hestia domain discovery (dsearch;/etc/exim4/domains/)
# - name: Deploy Exim4 template with simplified macros (prevents tainted filename errors)
#   template:
#     src: exim4.conf.template.j2
#     dest: /etc/exim4/exim4.conf.template
```

### Monitoring Verification (Tomorrow 02:00 UTC)

```bash
# Check if template was modified (should be EMPTY if fix worked)
ssh root@100.102.0.120 "pct exec 130 -- tail -50 /var/log/exim-template-modifications.log"

# Verify template is healthy (should be ~513 lines)
ssh root@100.102.0.120 "pct exec 130 -- wc -l /etc/exim4/exim4.conf.template"
```

### Prevention

To prevent recurrence:
1. **Always deploy Ansible role changes to PCT-110** after local git commits
2. **Never leave local uncommitted changes** as the only fix
3. **Monitor PCT-110 cron logs** regularly:
   ```bash
   ssh root@100.102.0.120 "pct exec 110 -- tail -50 /var/log/cron-hestia-logs.log"
   ```

### Related Systems

| Container | IP | Purpose | Cron Schedule |
|-----------|-----|---------|---------------|
| PCT-110 | N/A | Ansible management | Daily 02:00, Sun 04:00, 05:00, 06:00 |
| PCT-130 | 192.168.1.30 | Hestia mail server | Queue processing every 2 min |
| pve2 | 192.168.1.10 | Proxmox host | Backup at 02:00, 03:00 |

**Last Verified**: 2026-01-17 19:00 UTC
**Verified By**: jmvl
**Reference Config**: `exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06`
**Fix Commit**: 9f0aa26
**PCT-110 Fix Deployed**: 2026-01-17 18:45 UTC
