# Hestia Exim Configuration Corruption - Email Delivery Failure

**Date**: 2026-01-14
**System**: Hestia Mail Server (PCT 130 at 192.168.1.30)
**Severity**: **CRITICAL** - Complete incoming email failure
**Status**: ✅ **RESOLVED**
**Author**: Infrastructure Team (Claude Code)

---

## Executive Summary

**Critical Issue**: Incoming email delivery failed for ALL domains (accelior.com, vega-messenger.com, acmea.tech, etc.) due to corrupted Exim configuration file. The issue was caused by a malformed Exim template that was deployed during the 2026-01-08 maintenance intervention, followed by an automatic configuration regeneration on 2026-01-14 02:00 UTC.

**Impact**:
- All incoming emails rejected with "unrouteable address" error
- Multiple domains affected
- User-reported: jmvl@vega-messenger.com not receiving emails

**Resolution**:
- Restored proper Exim template from backup
- Regenerated Exim configuration
- Verified email delivery working

---

## Root Cause Analysis

### Initial Symptom
User reported not receiving emails at jmvl@vega-messenger.com.

### Investigation Process

**Phase 1: Evidence Gathering**
- Checked mail logs - found rejections for both jmvl@vega-messenger.com AND jmvl@accelior.com
- Dovecot logs showed successful IMAP logins (mailbox access working)
- Exim queue was empty (no stuck messages)

**Phase 2: Routing Test**
```bash
exim4 -bt jmvl@vega-messenger.com
# Result: jmvl@vega-messenger.com is undeliverable: Unrouteable address

exim4 -bt jmvl@accelior.com
# Result: jmvl@accelior.com is undeliverable: Unrouteable address
```
Both accounts showing as "unrouteable" indicated a **system-wide routing failure**, not a specific domain issue.

**Phase 3: Configuration File Analysis**

**CRITICAL DISCOVERY**: The `/var/lib/exim4/config.autogenerated` file was only **15 lines** long:

```conf
#########
# WARNING WARNING WARNING
# This file was generated dynamically from
# non-split config (/etc/exim4/exim4.conf.localmacros
# and /etc/exim4/exim4.conf.template).
#########

SMTP_RELAY_FILE = /etc/exim4/smtp_relay.conf
OUTGOING_IP =
DKIM_FILE =
```

The file was **completely broken** - missing:
- All router definitions
- All transport definitions
- All ACL definitions
- **Critical**: `domainlist local_domains` definition

**Phase 4: Root Cause Identified**

The `/etc/exim4/exim4.conf.template` was replaced during the 2026-01-08 maintenance with a **26-line documentation file**:

```conf
# Exim4 Configuration Template - Simplified Macros
# Deployed by Ansible - Hestia Mail Server Maintenance
# Purpose: Simplified macros to prevent "tainted filename" errors in Exim 4.95+
# ...
SMTP_RELAY_FILE = /etc/exim4/smtp_relay.conf
OUTGOING_IP =
DKIM_FILE =
```

This was intended as **documentation only**, but on **2026-01-14 02:00 UTC**, something triggered `update-exim4.conf` which regenerated `/var/lib/exim4/config.autogenerated` from this broken template.

**Timeline**:
1. **2026-01-08**: Maintenance intervention - created 26-line "simplified template" as documentation
2. **2026-01-14 02:00**: Cron job or automated process triggered `update-exim4.conf`
3. **2026-01-14 02:00**: `/var/lib/exim4/config.autogenerated` regenerated with only 15 lines
4. **2026-01-14 ~02:00**: All incoming emails started failing with "unrouteable address"

---

## The Fix

### Step 1: Restore Proper Exim Template

```bash
ssh root@192.168.1.30
cp /etc/exim4/exim4.conf.template.backup-20260108 /etc/exim4/exim4.conf.template
```

Verified restoration:
```bash
head -30 /etc/exim4/exim4.conf.template
```

Output showed proper template:
```conf
######################################################################
#          Exim configuration file for Hestia Control Panel          #
######################################################################

SPAMASSASSIN = yes
SPAM_SCORE = 50
SPAM_REJECT_SCORE = 100
CLAMD = yes

domainlist local_domains = dsearch;/etc/exim4/domains/ : lsearch;/etc/exim4/domains/domains.list
domainlist relay_to_domains = dsearch;/etc/exim4/domains/
hostlist relay_from_hosts = 127.0.0.1 : 192.168.1.0/24
# ... (full 513-line template)
```

### Step 2: Regenerate Exim Configuration

```bash
update-exim4.conf
```

This regenerated `/var/lib/exim4/config.autogenerated` with the complete configuration.

### Step 3: Reload Exim Service

```bash
systemctl reload exim4
```

Verified in logs:
```
2026-01-14 12:58:54 pid 1191869: SIGHUP received: re-exec daemon
2026-01-14 12:58:54 exim 4.95 daemon started: pid=1191869, -q30m, listening for SMTP on port 25 (IPv4) port 587 (IPv4) and for SMTPS on port 465 (IPv4)
```

### Step 4: Verify Email Routing

```bash
exim4 -bt jmvl@vega-messenger.com
# Result: jmvl@vega-messenger.com
#         router = localuser, transport = local_delivery ✅

exim4 -bt jmvl@accelior.com
# Result: jmvl@accelior.com
#         router = localuser, transport = local_delivery ✅
```

### Step 5: Test Email Delivery

```bash
echo 'Test email from root' | mail -s 'Test - Hestia mail recovered' jmvl@vega-messenger.com
```

Verified delivery in logs:
```
2026-01-14 12:59:05 1vg0Sn-00AofG-8q => jmvl <jmvl@vega-messenger.com> R=localuser T=local_delivery
2026-01-14 12:59:05 1vg0Sn-00AofG-8q Completed ✅
```

Verified in mailbox:
```bash
ls -la /home/vega/mail/vega-messenger.com/jmvl/new/
# -rw-rw----  1 vega mail   587 Jan 14 12:59 1768395545.M331242P2578042.mail.vega-messenger.com ✅
```

---

## Affected Domains

All mail domains on Hestia were affected:

| Domain | Hestia User | Status After Fix |
|--------|-------------|------------------|
| accelior.com | accelior | ✅ Working |
| vega-messenger.com | vega | ✅ Working |
| acmea.tech | jmvl | ✅ Working |
| artbit.gallery | artbit | ✅ Working |
| vidsnap.me | vidsnap | ✅ Working |

---

## Preventive Measures

### Immediate Actions Taken

1. ✅ **Restored proper template** from backup
2. ✅ **Removed problematic documentation file** from template location
3. ✅ **Verified all domains routing correctly**

### Recommended Follow-up Actions

1. **Prevent Future Template Corruption**
   ```bash
   # The 26-line "simplified template" should be stored separately
   # NOT as /etc/exim4/exim4.conf.template
   mv /etc/exim4/exim4.conf.template /etc/exim4/exim4.conf.template.restored
   # Keep proper HestiaCP template in place
   ```

2. **Monitor Configuration Regeneration**
   - Add cron job check for config file size:
   ```bash
   # If /var/lib/exim4/config.autogenerated is < 1000 lines, alert
   ```

3. **Automate Exim Configuration Verification**
   ```bash
   # Add to monitoring script
   exim4 -bt jmvl@vega-messenger.com | grep -q "local_delivery" || alert
   ```

4. **Ansible Role Fix Required**
   - The Ansible role that deployed the 26-line template needs correction
   - See: `/ansible/roles/hestia/tasks/exim_config.yml`
   - **DO NOT** replace the full template with documentation snippets

5. **Document the Simplified Macro Approach Properly**
   - Store simplified macro documentation in a separate file
   - Example: `/etc/exim4/simplified_macros_reference.txt`
   - Never use as the actual template

---

## Lessons Learned

### What Went Wrong

1. **Confusion Between Template and Documentation**
   - The 26-line file was intended as documentation of the macro simplification
   - It was placed at the template path, replacing the actual configuration
   - This was a misunderstanding during the 2026-01-08 maintenance

2. **No Verification After Template Changes**
   - No automated check to verify Exim configuration was valid after changes
   - The broken config persisted until incoming emails started failing

3. **Automatic Regeneration Risk**
   - `update-exim4.conf` was triggered automatically (likely by cron)
   - No safeguard to detect broken template before regeneration

### Correct Approach for Future Changes

When applying Exim configuration fixes:

1. **NEVER replace the entire template** - edit only the specific lines needed
2. **ALWAYS verify the config after changes**:
   ```bash
   # Check template is valid
   wc -l /etc/exim4/exim4.conf.template  # Should be ~500+ lines
   # Check generated config is valid
   wc -l /var/lib/exim4/config.autogenerated  # Should be ~800+ lines
   # Test routing
   exim4 -bt test@localdomain
   ```
3. **Keep documentation separate** from actual configuration files
4. **Use version control** for configuration files to catch accidental replacements

---

## Related Documentation

- **2026-01-08 Intervention**: `/docs/hestia/hestia-mail-server-maintenance-intervention-2026-01-08.md`
- **Ansible Improvement Plan**: `/docs/hestia/hestia-ansible-improvement-plan-2026-01-08.md`
- **Hestia Overview**: `/docs/hestia/hestia.md`
- **Infrastructure Database**: `/infrastructure-db/infrastructure.db`

---

## Recovery Timeline

| Time | Event |
|------|-------|
| 2026-01-08 14:19 | Maintenance intervention - created 26-line template |
| 2026-01-14 02:00 | `update-exim4.conf` regenerated config from broken template |
| 2026-01-14 12:47 | First detected rejection (Bitwarden email) |
| 2026-01-14 12:58 | Root cause identified - broken config file |
| 2026-01-14 12:58 | Template restored from backup |
| 2026-01-14 12:58 | Config regenerated |
| 2026-01-14 12:59 | Exim reloaded, routing verified |
| 2026-01-14 12:59 | Test email delivered successfully |
| **Total Downtime** | **~1 hour** (02:00 - 12:59 UTC) |

---

## Verification Commands

For future verification of email system health:

```bash
# Quick health check
ssh root@192.168.1.30 'exim4 -bt jmvl@vega-messenger.com | grep -q "local_delivery" && echo "✅ Routing OK" || echo "❌ Routing BROKEN"'

# Check config file size (should be 800+ lines)
ssh root@192.168.1.30 'wc -l /var/lib/exim4/config.autogenerated | awk "{if(\$1>800) print \"✅ Config OK\"; else print \"❌ Config TOO SHORT\"}"'

# Test delivery to multiple domains
for domain in accelior.com vega-messenger.com acmea.tech; do
  echo "Testing $domain..."
  exim4 -bt jmvl@$domain | grep "local_delivery" && echo "✅ $domain OK" || echo "❌ $domain FAILED"
done
```

---

**Document Version**: 1.0
**Created**: 2026-01-14
**Last Updated**: 2026-01-14 13:00 UTC
**Status**: ✅ **RESOLVED**
**Next Review**: 2026-01-21
