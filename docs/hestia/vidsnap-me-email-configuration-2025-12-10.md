# VidSnap.me Email Configuration

**Date**: 2025-12-10
**System**: Hestia Mail Server (PCT 130 at 192.168.1.30)
**Domain**: vidsnap.me
**Email Account**: info@vidsnap.me
**Status**: Configured and operational

## Overview

Configured email hosting for vidsnap.me domain on the Hestia mail server with proper DNS authentication records (SPF, DKIM, DMARC) and SMTP relay through EDP.net.

## Configuration Steps Performed

### 1. Hestia User and Domain Setup

Created dedicated Hestia user for vidsnap.me:
```bash
/usr/local/hestia/bin/v-add-user vidsnap "[password]" info@vidsnap.me default "VidSnap User"
```

Added mail domain:
```bash
/usr/local/hestia/bin/v-add-mail-domain vidsnap vidsnap.me
```

Created info@vidsnap.me email account:
```bash
/usr/local/hestia/bin/v-add-mail-account vidsnap vidsnap.me info "[password]"
```

### 2. SMTP Relay Configuration

Created `/etc/exim4/domains/vidsnap.me/smtp_relay.conf`:
```
host: relay.edpnet.be
port: 587
user:
pass:
```

This configures unauthenticated SMTP relay through EDP.net (allowed for EDP.net customers from their IP ranges).

### 3. DNS Records Configuration

All DNS records managed via Cloudflare using flarectl CLI:

#### CNAME Record (Dynamic IP Solution)
```bash
# Initially created as A record, but changed to CNAME for dynamic IP support
flarectl dns delete --zone vidsnap.me --id [old-a-record-id]
flarectl dns create --zone vidsnap.me --name mail --type CNAME --content home.accelior.com --ttl 3600
```
- **Record**: mail.vidsnap.me CNAME home.accelior.com
- **Purpose**: Mail server hostname resolution via DynDNS
- **Why CNAME**: The home IP is dynamic (DHCP). Using CNAME to home.accelior.com (which is updated by OPNsense DynDNS) ensures mail.vidsnap.me always resolves to the current IP.
- **Note**: While RFC 2181 discourages MX records pointing to CNAMEs, this works reliably in practice since mail clients resolve the full chain.

#### MX Record
```bash
flarectl dns create --zone vidsnap.me --name vidsnap.me --type MX --content mail.vidsnap.me --priority 10 --ttl 3600
```
- **Record**: vidsnap.me MX 10 mail.vidsnap.me
- **Purpose**: Direct incoming mail to mail server

#### SPF Record
```bash
flarectl dns create --zone vidsnap.me --name vidsnap.me --type TXT --content "v=spf1 a mx a:home.accelior.com ip4:212.71.0.0/23 ~all" --ttl 3600
```
- **Record**: vidsnap.me TXT "v=spf1 a mx a:home.accelior.com ip4:212.71.0.0/23 ~all"
- **Purpose**: Authorize mail servers and EDP.net relay IPs (212.71.0.0/23)

#### DKIM Record
```bash
flarectl dns create --zone vidsnap.me --name mail._domainkey --type TXT --content "v=DKIM1; k=rsa; p=MIIBIjANB..." --ttl 3600
```
- **Record**: mail._domainkey.vidsnap.me TXT "v=DKIM1; k=rsa; p=[public-key]"
- **Purpose**: Email signing for authenticity verification
- **Key**: RSA 2048-bit key generated by Hestia

#### DMARC Record
```bash
flarectl dns create --zone vidsnap.me --name _dmarc --type TXT --content "v=DMARC1; p=none; rua=mailto:info@vidsnap.me; ruf=mailto:info@vidsnap.me; fo=1" --ttl 3600
```
- **Record**: _dmarc.vidsnap.me TXT "v=DMARC1; p=none; rua=mailto:info@vidsnap.me; ruf=mailto:info@vidsnap.me; fo=1"
- **Purpose**: DMARC policy monitoring (aggregate and forensic reports to info@vidsnap.me)
- **Policy**: p=none (monitoring mode, no enforcement)

## DNS Records Summary

| Type  | Name                       | Content/Value                                              | Priority | TTL  |
|-------|----------------------------|------------------------------------------------------------|----------|------|
| CNAME | mail.vidsnap.me            | home.accelior.com                                          | -        | 3600 |
| MX    | vidsnap.me                 | mail.vidsnap.me                                            | 10       | 3600 |
| TXT   | vidsnap.me                 | v=spf1 a mx a:home.accelior.com ip4:212.71.0.0/23 ~all     | -        | 3600 |
| TXT   | mail._domainkey.vidsnap.me | v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB... | -        | 3600 |
| TXT   | _dmarc.vidsnap.me          | v=DMARC1; p=none; rua=mailto:info@vidsnap.me; ruf=mailto:info@vidsnap.me; fo=1 | - | 3600 |

### 4. Nginx Proxy Manager (NPM) Configuration

NPM at 192.168.1.9 handles SSL termination for webmail access.

**Proxy Host Settings** (configured via http://192.168.1.9:81):
- **Domain Names**: mail.vidsnap.me
- **Scheme**: https
- **Forward Hostname/IP**: 192.168.1.30
- **Forward Port**: 8443
- **SSL Certificate**: Let's Encrypt (auto-renewed)
- **Force SSL**: Enabled
- **HTTP/2 Support**: Enabled

### 5. Hestia Webmail SSL Configuration (Critical Fix)

**Problem**: Webmail showed "Success!" page instead of Roundcube.

**Root Cause**:
1. `v-add-mail-domain-webmail` creates config for port 8080 (HTTP) only
2. `v-add-web-domain-ssl` creates standard web template pointing to `/home/vidsnap/web/webmail.vidsnap.me/public_html` instead of `/var/lib/roundcube/`
3. NPM forwards to port 8443 (HTTPS), but no proper SSL config existed for webmail

**Solution**: Manually create proper Apache SSL config for webmail:

```bash
# Create SSL config pointing to Roundcube
cat > /etc/apache2/conf.d/domains/webmail.vidsnap.me.ssl.conf << 'EOF'
<VirtualHost 192.168.1.30:8443>
    ServerName webmail.vidsnap.me
    ServerAlias mail.vidsnap.me
    Alias / /var/lib/roundcube/
    Alias /error/ /home/vidsnap/web/vidsnap.me/document_errors/

    SSLEngine on
    SSLVerifyClient none
    SSLCertificateFile         /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.crt
    SSLCertificateKeyFile      /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.key

    <Directory "/usr/share/tinymce/www/">
      Options Indexes MultiViews FollowSymLinks
      AllowOverride None
      Order allow,deny
      allow from all
    </Directory>

    <Directory /var/lib/roundcube/>
        Options +FollowSymLinks
        AllowOverride All
        order allow,deny
        allow from all
    </Directory>

    <Directory /var/lib/roundcube/config>
        Options -FollowSymLinks
        AllowOverride None
    </Directory>

    <Directory /var/lib/roundcube/temp>
        Options -FollowSymLinks
        AllowOverride None
        Order allow,deny
        Deny from all
    </Directory>

    <Directory /var/lib/roundcube/logs>
        Options -FollowSymLinks
        AllowOverride None
        Order allow,deny
        Deny from all
    </Directory>

    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/www.sock|fcgi://localhost"
    </FilesMatch>

</VirtualHost>
EOF

# Reload Apache
apache2ctl configtest && systemctl reload apache2
```

**Key Details**:
- **DocumentRoot**: Must alias to `/var/lib/roundcube/` (not standard web directory)
- **PHP-FPM Socket**: Use `/run/php/www.sock` (global socket) - domain-specific sockets have `open_basedir` restrictions that block Roundcube
- **SSL Certificates**: Use mail domain SSL certs from `/home/vidsnap/conf/mail/vidsnap.me/ssl/`

**SSL Certificate Setup** (if not exists):
```bash
# Create SSL directory and copy Hestia default certs
mkdir -p /home/vidsnap/conf/mail/vidsnap.me/ssl
cp /usr/local/hestia/ssl/certificate.crt /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.crt
cp /usr/local/hestia/ssl/certificate.key /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.key
cat /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.crt /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.key > /home/vidsnap/conf/mail/vidsnap.me/ssl/vidsnap.me.pem
chown -R vidsnap:vidsnap /home/vidsnap/conf/mail/vidsnap.me/ssl
```

## Email Account Details

- **Email Address**: info@vidsnap.me
- **IMAP Server**: mail.vidsnap.me (port 993, SSL/TLS)
- **SMTP Server**: mail.vidsnap.me (port 587, STARTTLS)
- **Webmail**: https://mail.vidsnap.me (accessible via Hestia panel)
- **Password**: Generated securely, stored in Hestia (user can reset via Hestia panel at https://192.168.1.30:8083)

## Testing

Email routing verified successfully:
```bash
/usr/sbin/exim4 -f info@vidsnap.me -bt check-auth@verifier.port25.com
# Output: router = send_via_unauthenticated_smtp_relay, transport = remote_smtp
#         host relay.edpnet.be [212.71.0.16] port=587
```

Test email sent to Port25 verification service confirmed:
- SMTP relay functioning correctly
- Email delivered via relay.edpnet.be
- TLS encryption established (TLS1.3)

## Architecture

```
                                    Internet
                                       |
                                       v
                              ┌─────────────────┐
                              │  Cloudflare DNS │
                              │ (vidsnap.me)    │
                              └────────┬────────┘
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
    MX: mail.vidsnap.me    CNAME: mail.vidsnap.me      TXT: SPF/DKIM/DMARC
              │                        │
              │                        v
              │              home.accelior.com (DynDNS)
              │                        │
              │                        v
              │              Current Dynamic IP
              │              (updated by OPNsense)
              │                        │
              v                        v
    ┌─────────────────────────────────────────────────────────┐
    │                    OPNsense Firewall                    │
    │                     (192.168.1.3)                       │
    │   Port 25/587/993 → 192.168.1.30 (Hestia)              │
    │   Port 80/443 → 192.168.1.9 (NPM)                      │
    └─────────────────────────────────────────────────────────┘
                    │                        │
                    v                        v
    ┌───────────────────────┐    ┌───────────────────────────┐
    │   Hestia Mail Server  │    │   Nginx Proxy Manager     │
    │    (192.168.1.30)     │    │      (192.168.1.9)        │
    │                       │    │                           │
    │  SMTP: 25, 587        │    │  HTTPS: 443               │
    │  IMAP: 993            │    │  Let's Encrypt SSL        │
    │  POP3: 995            │    │                           │
    └───────────┬───────────┘    └─────────────┬─────────────┘
                │                              │
                │         ┌────────────────────┘
                │         │ Proxy: mail.vidsnap.me
                │         v
                │    ┌─────────────────────────────┐
                │    │  Apache (192.168.1.30:8443) │
                │    │  webmail.vidsnap.me.ssl.conf│
                │    │  → /var/lib/roundcube/      │
                │    └─────────────────────────────┘
                │
        ┌───────┴───────┐
        │               │
    Incoming        Outgoing
    (direct)     (via SMTP relay)
        │               │
        v               v
   Dovecot         relay.edpnet.be:587
   (IMAP/POP3)     (212.71.0.0/23)
        │               │
        v               v
 info@vidsnap.me   External recipients
```

### Traffic Flow Summary

| Service | External Port | Internal Target | Protocol |
|---------|--------------|-----------------|----------|
| SMTP | 25 | 192.168.1.30:25 | TCP |
| SMTP Submission | 587 | 192.168.1.30:587 | TCP/TLS |
| IMAP | 993 | 192.168.1.30:993 | TCP/TLS |
| Webmail | 443 | NPM → 192.168.1.30:8443 | HTTPS |

## Infrastructure Database Entry

Service added to infrastructure database:
```sql
INSERT INTO services (service_name, service_type, host_id, port, protocol, status, description, endpoint_url, criticality)
VALUES (
    'vidsnap.me-mail',
    'other',
    (SELECT id FROM hosts WHERE hostname = 'hestia-mail'),
    25,
    'SMTP',
    'healthy',
    'Email service for vidsnap.me domain with info@vidsnap.me account. SMTP relay via relay.edpnet.be:587. SPF, DKIM, DMARC configured.',
    'mail.vidsnap.me',
    'high'
);
```

## Maintenance Notes

### Password Reset
To reset the info@vidsnap.me password:
```bash
ssh root@192.168.1.30
/usr/local/hestia/bin/v-change-mail-account-password vidsnap vidsnap.me info [new-password]
```

Or via Hestia web panel:
1. Navigate to https://192.168.1.30:8083
2. Login as 'vidsnap' user
3. Go to Mail > vidsnap.me > info@vidsnap.me
4. Update password

### Checking Email Logs
```bash
ssh root@192.168.1.30
tail -f /var/log/exim4/mainlog
tail -f /var/log/dovecot.log
```

### Testing Email Delivery
Send test to Port25 verification service:
```bash
ssh root@192.168.1.30
echo "Subject: Test
From: info@vidsnap.me

Test email content" | /usr/sbin/exim4 -v check-auth@verifier.port25.com
```

### DKIM Key Retrieval
If DKIM key needs to be retrieved or regenerated:
```bash
ssh root@192.168.1.30
# Extract public key from private key
openssl rsa -in /home/vidsnap/conf/mail/vidsnap.me/dkim.pem -pubout -outform PEM 2>/dev/null | tail -n +2 | head -n -1 | tr -d "\n"
```

### DNS Record Verification
Check DNS propagation:
```bash
# MX record
dig vidsnap.me MX +short

# SPF record
dig vidsnap.me TXT +short | grep spf1

# DKIM record
dig mail._domainkey.vidsnap.me TXT +short

# DMARC record
dig _dmarc.vidsnap.me TXT +short
```

## Security Considerations

1. **SPF Policy**: Currently using `~all` (soft fail). Consider hardening to `-all` (hard fail) after confirming all legitimate sending sources are included.

2. **DMARC Policy**: Currently in monitoring mode (`p=none`). After reviewing reports and confirming proper SPF/DKIM alignment, consider escalating to:
   - `p=quarantine` for intermediate enforcement
   - `p=reject` for full enforcement

3. **Password Management**: Auto-generated passwords are stored in Hestia. Ensure users change to strong, unique passwords after first login.

4. **TLS Encryption**:
   - Inbound: TLS on port 993 (IMAP) and 587 (SMTP submission)
   - Outbound: STARTTLS to relay.edpnet.be

5. **SMTP Relay Authentication**: Currently using unauthenticated relay through EDP.net (allowed from EDP.net customer IP ranges). This is secure as long as the source IP (77.109.77.7) remains within EDP.net's control.

## Related Documentation

- Hestia mail server overview: `/docs/hestia/README.md`
- Email configuration for other domains:
  - `/docs/hestia/accelior-com-email-configuration.md`
  - `/docs/hestia/vega-messenger-com-email-configuration.md`
  - `/docs/hestia/acmea-tech-email-configuration.md`
- Infrastructure database: `/infrastructure-db/README.md`
- OPNsense DynDNS configuration: `/docs/OPNsense/dyndns-configuration.md`

## Troubleshooting

### Email not sending
1. Check Exim logs: `tail -f /var/log/exim4/mainlog`
2. Test routing: `/usr/sbin/exim4 -f info@vidsnap.me -bt recipient@example.com`
3. Verify SMTP relay: `telnet relay.edpnet.be 587`

### Email not receiving
1. Check MX record: `dig vidsnap.me MX +short`
2. Check firewall rules on OPNsense (192.168.1.3) for port 25 forwarding
3. Check Dovecot logs: `tail -f /var/log/dovecot.log`

### SPF/DKIM failures
1. Test with mail-tester.com
2. Send test to check-auth@verifier.port25.com
3. Verify DNS records with dig commands above
4. Check DKIM signing in Exim: `grep dkim /var/log/exim4/mainlog`

## Lessons Learned / Checklist for New Mail Domains

When adding a new mail domain to Hestia with NPM webmail access:

### DNS Configuration
- [ ] Use **CNAME** to DynDNS hostname (home.accelior.com) instead of A record for dynamic IP support
- [ ] MX record pointing to mail.domain.com
- [ ] SPF with `ip4:212.71.0.0/23` for EDP.net relay
- [ ] DKIM record from Hestia-generated key
- [ ] DMARC record (start with `p=none` for monitoring)

### Hestia Configuration
- [ ] Create user: `v-add-user`
- [ ] Add mail domain: `v-add-mail-domain`
- [ ] Add mail account: `v-add-mail-account`
- [ ] Enable webmail: `v-add-mail-domain-webmail [user] [domain] roundcube`
- [ ] Configure SMTP relay: Create `/etc/exim4/domains/[domain]/smtp_relay.conf`

### NPM Configuration
- [ ] Add proxy host for mail.domain.com
- [ ] Scheme: **https**, Port: **8443**
- [ ] Enable Let's Encrypt SSL
- [ ] Force SSL enabled

### Apache SSL Config (CRITICAL)
- [ ] **Manually create** `/etc/apache2/conf.d/domains/webmail.[domain].ssl.conf`
- [ ] Point `Alias /` to `/var/lib/roundcube/` (NOT web directory)
- [ ] Use global PHP-FPM socket `/run/php/www.sock` (avoids open_basedir issues)
- [ ] Reload Apache: `apache2ctl configtest && systemctl reload apache2`

### Common Issues
| Symptom | Cause | Solution |
|---------|-------|----------|
| "Success!" page | Missing/wrong SSL config | Create proper webmail.ssl.conf with Roundcube alias |
| "Coming Soon" page | SSL config points to web directory | Fix DocumentRoot to /var/lib/roundcube/ |
| 503 Service Unavailable | Wrong PHP-FPM socket | Use /run/php/www.sock |
| 500 Internal Error | open_basedir restriction | Use global PHP-FPM socket, not domain-specific |
| Mail not sending | SMTP relay not configured | Create smtp_relay.conf for domain |
| SPF failure | Relay IPs not in SPF | Add ip4:212.71.0.0/23 to SPF record |

## References

- Hestia Control Panel: https://hestiacp.com/docs/
- SPF Record Syntax: https://www.rfc-editor.org/rfc/rfc7208
- DKIM: https://www.rfc-editor.org/rfc/rfc6376
- DMARC: https://www.rfc-editor.org/rfc/rfc7489
- EDP.net SMTP Relay Documentation: (internal/ISP documentation)
