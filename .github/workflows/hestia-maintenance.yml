---
name: Hestia Mail Server Maintenance

on:
  schedule:
    # Run every Sunday at 4:00 AM UTC (matches cron job)
    - cron: '0 4 * * 0'
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to run'
        required: false
        default: 'playbooks/hestia-mail-maintenance-refactored.yml'
        type: choice
        options:
          - playbooks/hestia-mail-maintenance-refactored.yml
          - playbooks/jira-maintenance-refactored.yml
          - playbooks/confluence-maintenance-refactored.yml
          - playbooks/docker-vm-maintenance-refactored.yml
      tags:
        description: 'Tags to run (comma-separated, leave empty for all)'
        required: false
        default: ''
        type: string

jobs:
  maintenance:
    name: Run Maintenance Playbook
    runs-on: ubuntu-latest
    # Only run scheduled jobs on the main repository
    if: |
      (github.event_name == 'schedule' && github.repository == 'jmvl/internet-control') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible-core

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.1.30 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Set up Ansible vault password
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ~/.ansible-vault-password
          chmod 600 ~/.ansible-vault-password

      - name: Configure Ansible
        working-directory: ./ansible
        run: |
          cat > ansible.cfg <<EOF
          [defaults]
          inventory = hosts.ini
          vault_password_file = ~/.ansible-vault-password
          host_key_checking = False
          retry_files_enabled = False
          stdout_callback = yaml
          EOF

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@192.168.1.30 "echo 'SSH connection successful'"

      - name: Run maintenance playbook
        working-directory: ./ansible
        run: |
          PLAYBOOK="${{ github.event.inputs.playbook || 'playbooks/hestia-mail-maintenance-refactored.yml' }}"
          TAGS="${{ github.event.inputs.tags }}"

          if [ -n "$TAGS" ]; then
            echo "Running: ansible-playbook $PLAYBOOK --tags \"$TAGS\""
            ansible-playbook "$PLAYBOOK" --tags "$TAGS"
          else
            echo "Running: ansible-playbook $PLAYBOOK"
            ansible-playbook "$PLAYBOOK"
          fi

      - name: Create maintenance report
        if: always()
        run: |
          echo "## Maintenance Report :page_facing_up:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Playbook**: ${{ github.event.inputs.playbook || 'playbooks/hestia-mail-maintenance-refactored.yml' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Maintenance completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Maintenance failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Maintenance playbook failed! Check the logs for details."
          # You can add additional notification methods here (email, Slack, etc.)

  health-check:
    name: Post-Maintenance Health Check
    runs-on: ubuntu-latest
    needs: maintenance
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 192.168.1.30 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check service status
        run: |
          echo "## Service Status Check :hospital:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ssh -i ~/.ssh/id_rsa root@192.168.1.30 "
            echo 'Dovecot status:'
            systemctl status dovecot --no-pager | head -n 3
            echo ''
            echo 'Exim4 status:'
            systemctl status exim4 --no-pager | head -n 3
            echo ''
            echo 'Disk usage:'
            df -h / | tail -n 1
            echo ''
            echo 'Memory usage:'
            free -h | grep Mem
          " >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check mail queue
        run: |
          echo "## Mail Queue Status :mailbox:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ssh -i ~/.ssh/id_rsa root@192.168.1.30 "
            echo 'Exim queue summary:'
            exim4 -bp | exim4 -bpr | head -n 20
            echo ''
            echo 'Total messages in queue:'
            exim4 -bpc
          " >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Verify critical services
        run: |
          ssh -i ~/.ssh/id_rsa root@192.168.1.30 "
            # Check if critical services are running
            services=('dovecot' 'exim4' 'spamd')
            all_ok=true

            for service in \"\${services[@]}\"; do
              if systemctl is-active --quiet \"\$service\"; then
                echo \"✅ \$service is running\"
              else
                echo \"❌ \$service is NOT running\"
                all_ok=false
              fi
            done

            if [ \"\$all_ok\" = false ]; then
              echo '::error::Critical services are not running!'
              exit 1
            fi
          "

      - name: Check recent logs
        run: |
          echo "## Recent Maintenance Logs :memo:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ssh -i ~/.ssh/id_rsa root@192.168.1.30 "
            if [ -f /var/log/hestia-maintenance.log ]; then
              echo 'Last 20 lines of maintenance log:'
              tail -n 20 /var/log/hestia-maintenance.log
            else
              echo 'No maintenance log found'
            fi
          " >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
