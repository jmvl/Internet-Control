---
# VM System Update Playbook
# Purpose: Update Debian-based VMs and LXC containers with system packages
# Usage: ansible-playbook -i hosts.ini playbooks/vm-system-update.yml
#        ansible-playbook -i hosts.ini playbooks/vm-system-update.yml --limit docker-debian
#        ansible-playbook -i hosts.ini playbooks/vm-system-update.yml --check  # Dry run

- name: System Update for Debian VMs/LXC
  hosts: debian_vms
  become: yes
  gather_facts: yes
  serial: 1  # Update one host at a time for safety

  vars:
    maintenance_log: "/var/log/ansible-system-update.log"
    reboot_timeout: 300
    auto_reboot: false  # Set to true to enable automatic reboots

  tasks:
    # ========================================
    # PRE-UPDATE CHECKS
    # ========================================

    - name: Log update start
      lineinfile:
        path: "{{ maintenance_log }}"
        line: "=== System update started: {{ ansible_date_time.iso8601 }} ==="
        create: yes
      tags: always

    - name: Check disk space before updates
      shell: df -h / | tail -1 | awk '{print $4}'
      register: disk_free_before
      changed_when: false
      tags: pre-check

    - name: Check current kernel version
      shell: uname -r
      register: kernel_before
      changed_when: false
      tags: pre-check

    # ========================================
    # PACKAGE UPDATES
    # ========================================

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: update

    - name: Get list of upgradable packages
      shell: apt list --upgradable 2>/dev/null | grep -v "Listing" | wc -l
      register: upgradable_count
      changed_when: false
      tags: update

    - name: Display upgradable packages count
      debug:
        msg: "{{ upgradable_count.stdout }} packages available for upgrade on {{ inventory_hostname }}"
      tags: update

    - name: List upgradable packages (for logging)
      shell: apt list --upgradable 2>/dev/null | grep -v "Listing" | head -50
      register: upgradable_list
      changed_when: false
      tags: update

    - name: Perform dist-upgrade
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      register: apt_upgrade
      tags: update

    # ========================================
    # SECURITY UPDATES (if separate handling needed)
    # ========================================

    - name: Check for security updates specifically
      shell: |
        apt-get -s upgrade 2>/dev/null | grep -i security | head -10
      register: security_updates
      changed_when: false
      ignore_errors: yes
      tags: security

    # ========================================
    # CLEANUP
    # ========================================

    - name: Remove unused packages
      apt:
        autoremove: yes
      tags: cleanup

    - name: Clean apt cache
      apt:
        autoclean: yes
      tags: cleanup

    - name: Remove old kernels (keep last 2)
      shell: |
        dpkg -l 'linux-image-*' | awk '/^ii/{print $2}' | grep -v $(uname -r) | head -n -2 | xargs --no-run-if-empty apt-get -y purge
      ignore_errors: yes
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
      tags: cleanup

    # ========================================
    # REBOOT CHECK
    # ========================================

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
      tags: reboot

    - name: Display reboot requirement
      debug:
        msg: "REBOOT REQUIRED for {{ inventory_hostname }}"
      when: reboot_required.stat.exists
      tags: reboot

    - name: Reboot if required and auto_reboot is enabled
      reboot:
        reboot_timeout: "{{ reboot_timeout }}"
        msg: "Ansible initiated reboot after system updates"
      when:
        - reboot_required.stat.exists
        - auto_reboot | bool
      tags: reboot

    # ========================================
    # POST-UPDATE VERIFICATION
    # ========================================

    - name: Verify no packages need upgrade
      shell: apt list --upgradable 2>/dev/null | grep -v "Listing" | wc -l
      register: remaining_upgrades
      changed_when: false
      tags: verify

    - name: Check kernel version after update
      shell: uname -r
      register: kernel_after
      changed_when: false
      tags: verify

    - name: Check disk space after updates
      shell: df -h / | tail -1 | awk '{print $4}'
      register: disk_free_after
      changed_when: false
      tags: verify

    # ========================================
    # REPORTING
    # ========================================

    - name: Log update results
      blockinfile:
        path: "{{ maintenance_log }}"
        marker: "<!-- {mark} UPDATE {{ ansible_date_time.iso8601 }} -->"
        block: |
          Host: {{ inventory_hostname }}
          Date: {{ ansible_date_time.iso8601 }}
          Packages Upgraded: {{ upgradable_count.stdout }}
          Remaining: {{ remaining_upgrades.stdout }}
          Kernel Before: {{ kernel_before.stdout }}
          Kernel After: {{ kernel_after.stdout }}
          Disk Free Before: {{ disk_free_before.stdout }}
          Disk Free After: {{ disk_free_after.stdout }}
          Reboot Required: {{ reboot_required.stat.exists }}
      tags: always

    - name: Display update summary
      debug:
        msg: |
          ============================================
          UPDATE SUMMARY: {{ inventory_hostname }}
          ============================================
          Packages Available: {{ upgradable_count.stdout }}
          Updates Applied: {{ apt_upgrade.changed }}
          Remaining Upgrades: {{ remaining_upgrades.stdout }}
          Kernel: {{ kernel_before.stdout }} -> {{ kernel_after.stdout }}
          Disk Free: {{ disk_free_before.stdout }} -> {{ disk_free_after.stdout }}
          Reboot Required: {{ 'YES' if reboot_required.stat.exists else 'NO' }}
          ============================================
      tags: always

    - name: Mark update completion
      lineinfile:
        path: "{{ maintenance_log }}"
        line: "=== System update completed: {{ ansible_date_time.iso8601 }} ==="
      tags: always
