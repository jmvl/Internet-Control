---
# Exim4 Configuration Management
# Addresses issue: "tainted filename" errors in Exim 4.95+
# Based on intervention: /docs/hestia/hestia-mail-server-maintenance-intervention-2026-01-08.md

- name: Ensure Exim4 configuration directory exists
  file:
    path: /etc/exim4
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: config,exim

- name: Backup current Exim4 template
  copy:
    src: /etc/exim4/exim4.conf.template
    dest: "/etc/exim4/exim4.conf.template.backup-{{ ansible_date_time.iso8601 | regex_replace('[:]', '-') }}"
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  when: hestia_exim_config_backup | bool
  tags: config,exim,backup

- name: Deploy simplified SMTP relay configuration
  template:
    src: smtp_relay.conf.j2
    dest: /etc/exim4/smtp_relay.conf
    owner: Debian-exim
    group: mail
    mode: '0640'
  notify: Reload Exim4
  tags: config,exim,relay

# CRITICAL: This task MUST REMAIN DISABLED to prevent mail delivery failures
# The simplified template (1.3KB) breaks Hestia domain discovery (dsearch;/etc/exim4/domains/)
# which is required for local mail delivery and catch-all routing to work.
# INCIDENT: 2026-01-15 - Catch-all email broke because simplified template was deployed
# REFERENCE: /docs/troubleshooting/2026-01-15-hestia-exim-catchall-not-working-fix.md
# REFERENCE CONFIG: exim4.conf.template.REFERENCE-WORKING-2026-01-15.md5sum-44839e06 (20KB, 513 lines)
# Hestia manages its own Exim configuration - do not override it with Ansible.
# - name: Deploy Exim4 template with simplified macros (prevents tainted filename errors)
#   template:
#     src: exim4.conf.template.j2
#     dest: /etc/exim4/exim4.conf.template
#     owner: root
#     group: root
#     mode: '0644'
#     backup: yes
#   notify: Update Exim4 configuration
#   tags: config,exim,template

- name: Update Exim4 configuration from template
  command: update-exim4.conf
  notify: Reload Exim4
  tags: config,exim,update

- name: Verify Exim4 template is not corrupted
  ansible.builtin.stat:
    path: /etc/exim4/exim4.conf.template
  register: exim_template
  failed_when: exim_template.stat.size < 10000
  tags: config,exim,verify

- name: Verify Exim4 configuration is complete
  ansible.builtin.command: wc -l /var/lib/exim4/config.autogenerated
  register: exim_config_lines
  changed_when: false
  failed_when: exim_config_lines.stdout | int < 500
  tags: config,exim,verify

- name: Verify Exim4 configuration syntax
  command: exim4 -bV
  register: exim_config_check
  changed_when: false
  failed_when: exim_config_check.rc != 0
  tags: config,exim,verify

- name: Test Exim4 routing to external recipient
  command: exim4 -bt {{ hestia_exim_test_recipient }}
  args:
    stdin: "From: {{ hestia_exim_test_sender }}"
  register: exim_test_routing
  changed_when: false
  failed_when: "'relay.edpnet.be' not in exim_test_routing.stdout"
  when: hestia_exim_test_routing_enabled | bool
  tags: config,exim,verify,test

- name: Verify Hestia domain discovery is working (catch-all routing)
  command: exim4 -bt test@acmea.tech
  register: exim_catchall_test
  changed_when: false
  failed_when: "'jmvl@acmea.tech' not in exim_catchall_test.stdout"
  tags: config,exim,verify,test

- name: Display catch-all routing verification
  debug:
    msg: "{{ exim_catchall_test.stdout_lines }}"
  tags: config,exim,verify,test

- name: Display Exim4 routing test results
  debug:
    msg: "{{ exim_test_routing.stdout_lines }}"
  when: hestia_exim_test_routing_enabled | bool
  tags: config,exim,verify,test
