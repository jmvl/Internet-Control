---
# Confluence service-specific maintenance tasks

# ========================================
# CONFLUENCE LOG CLEANUP
# ========================================

- name: Find old Confluence logs (idempotent)
  find:
    paths: "{{ confluence_logs }}"
    patterns: "atlassian-confluence*.log.*,*.gz"
    age: "{{ log_retention_days }}d"
  register: old_confluence_logs
  ignore_errors: yes
  tags: logs,confluence_logs

- name: Remove old Confluence logs
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_confluence_logs.files }}"
  when: old_confluence_logs.matched > 0
  tags: logs,confluence_logs

- name: Truncate large Confluence logs (idempotent)
  shell: |
    find {{ confluence_logs }} -name "atlassian-confluence*.log" -type f \
      -size +{{ confluence_log_max_size }} \
      -exec truncate -s {{ confluence_log_truncate_size }} {} \; \
      2>/dev/null || true
  register: confluence_truncate
  changed_when: confluence_truncate.rc == 0
  tags: logs,confluence_logs

- name: Find old Catalina logs (idempotent)
  find:
    paths: "{{ catalina_logs }}"
    patterns: "catalina*.log.*,localhost*.log.*,*.gz"
    age: "{{ log_retention_days }}d"
  register: old_catalina_logs
  ignore_errors: yes
  tags: logs,catalina_logs

- name: Remove old Catalina logs
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_catalina_logs.files }}"
  when: old_catalina_logs.matched > 0
  tags: logs,catalina_logs

- name: Truncate catalina.out if too large (idempotent)
  shell: |
    if [ -f {{ catalina_logs }}/catalina.out ]; then
      size=$(stat -f%z {{ catalina_logs }}/catalina.out 2>/dev/null || stat -c%s {{ catalina_logs }}/catalina.out)
      if [ $size -gt 1073741824 ]; then
        tail -c {{ catalina_out_truncate_size }} {{ catalina_logs }}/catalina.out > {{ catalina_logs }}/catalina.out.tmp
        mv {{ catalina_logs }}/catalina.out.tmp {{ catalina_logs }}/catalina.out
        echo "Truncated catalina.out from $(($size / 1048576))MB to {{ catalina_out_truncate_size }}"
      fi
    fi
  register: catalina_truncate
  changed_when: "'Truncated' in catalina_truncate.stdout"
  tags: logs,catalina_logs

# ========================================
# CONFLUENCE WORK DIRECTORY CLEANUP
# ========================================

- name: Clean Confluence temp directory (idempotent)
  shell: |
    find {{ confluence_home }}/temp -type f -mtime +7 -delete 2>/dev/null || true
    find {{ confluence_home }}/temp -type d -empty -delete 2>/dev/null || true
  register: confluence_temp_clean
  changed_when: confluence_temp_clean.rc == 0
  tags: logs,work_cleanup

- name: Clean old Confluence backups (idempotent)
  shell: |
    find {{ confluence_home }}/backups -name "*.zip" -mtime +60 -delete 2>/dev/null || true
  register: confluence_backups_clean
  changed_when: confluence_backups_clean.rc == 0
  tags: logs,work_cleanup

- name: Clean old Confluence thumbnails cache (idempotent)
  shell: |
    find {{ confluence_home }}/thumbnails -type f -mtime +90 -delete 2>/dev/null || true
  register: thumbnails_clean
  changed_when: thumbnails_clean.rc == 0
  tags: logs,work_cleanup

- name: Clean Confluence plugin cache (idempotent)
  shell: |
    find {{ confluence_home }}/plugins-cache -type f -mtime +30 -delete 2>/dev/null || true
    find {{ confluence_home }}/bundled-plugins-cache -type f -mtime +30 -delete 2>/dev/null || true
  register: plugin_cache_clean
  changed_when: plugin_cache_clean.rc == 0
  tags: logs,work_cleanup

# ========================================
# CONFLUENCE SERVICE HEALTH CHECKS
# ========================================

- name: Check Confluence process status (idempotent)
  shell: ps aux | grep -i "[c]onfluence" | wc -l
  register: confluence_process_count
  changed_when: false
  tags: health,processes

- name: Check Confluence HTTP port (idempotent)
  shell: |
    netstat -tlnp | grep ':{{ confluence_http_port }}' || ss -tlnp | grep ':{{ confluence_http_port }}'
  register: confluence_port
  changed_when: false
  ignore_errors: yes
  tags: health,ports

- name: Check Synchrony port (idempotent)
  shell: |
    netstat -tlnp | grep ':{{ synchrony_port }}' || ss -tlnp | grep ':{{ synchrony_port }}'
  register: synchrony_port
  changed_when: false
  ignore_errors: yes
  tags: health,ports

- name: Check PostgreSQL processes (idempotent)
  shell: ps aux | grep -i "[p]ostgres" | wc -l
  register: db_process_count
  changed_when: false
  tags: health,database

# ========================================
# STORAGE CHECKS
# ========================================

- name: Check attachment storage usage (idempotent)
  shell: |
    du -sh {{ confluence_home }}/attachments 2>/dev/null || echo "0"
  register: attachment_size
  changed_when: false
  tags: health,storage

- name: Check Confluence index size (idempotent)
  shell: |
    du -sh {{ confluence_home }}/index 2>/dev/null || echo "0"
  register: index_size
  changed_when: false
  tags: health,storage

# ========================================
# DATABASE MAINTENANCE
# ========================================

- name: Ensure PostgreSQL is running (idempotent)
  systemd:
    name: postgresql
    state: started
    enabled: yes
  ignore_errors: yes
  tags: health,database

- name: Vacuum Confluence database (comprehensive only)
  shell: |
    su - postgres -c "vacuumdb --analyze confluence" 2>&1 || true
  when: comprehensive_maintenance is defined and comprehensive_maintenance | bool
  register: db_vacuum
  changed_when: db_vacuum.rc == 0
  ignore_errors: yes
  tags: comprehensive,database

# ========================================
# COMPREHENSIVE MAINTENANCE
# ========================================

- name: Clean APT cache thoroughly (comprehensive only)
  shell: |
    apt-get clean
    apt-get autoclean
    rm -rf /var/cache/apt/archives/*.deb
  when: comprehensive_maintenance is defined and comprehensive_maintenance | bool
  register: apt_cache_clean
  changed_when: apt_cache_clean.rc == 0
  tags: comprehensive
